import React, { useState, useEffect } from 'react';
import { 
  Send, 
  LayoutDashboard, 
  CheckCircle, 
  AlertTriangle, 
  Server, 
  Key, 
  ShieldAlert, 
  MousePointerClick,
  Monitor,
  HardDrive,
  Inbox,
  Archive,
  WifiOff // Icon f√ºr Offline-Modus
} from 'lucide-react';

export default function ITSupportApp() {
  // --- ZUSTAND (State) ---
  const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
  const [view, setView] = useState('setup'); // 'setup', 'form', 'dashboard'
  const [dashboardTab, setDashboardTab] = useState('inbox');
  const [loading, setLoading] = useState(false);
  const [isOfflineMode, setIsOfflineMode] = useState(false); // Zeigt an, ob wir im Fallback sind
  
  const [tickets, setTickets] = useState(() => {
    const saved = localStorage.getItem('it_tickets');
    return saved ? JSON.parse(saved) : [];
  });

  useEffect(() => {
    localStorage.setItem('it_tickets', JSON.stringify(tickets));
  }, [tickets]);

  useEffect(() => {
    if (apiKey && view === 'setup') setView('form');
  }, [apiKey]);

  // --- LOKALE SIMULATION (FALLBACK AGENT) ---
  // Diese Funktion springt ein, wenn die echte KI nicht erreichbar ist.
  const simulateLocalAI = (ticketData) => {
    const text = (ticketData.subject + " " + ticketData.description).toLowerCase();
    
    // 1. Einfache Keyword-Analyse f√ºr KATEGORIE
    let category = 'OTHER';
    
    if (text.match(/passwort|password|login|reset|zugang|locked|sperr/)) {
      category = 'PASSWORD_RESET';
    } else if (text.match(/maus|mouse|tastatur|keyboard|screen|bildschirm|drucker|printer|laptop|hardware|kabel|defekt/)) {
      category = 'HARDWARE';
    } else if (text.match(/software|office|excel|word|teams|outlook|install|update|fehler|error|absturz|startet nicht/)) {
      category = 'SOFTWARE';
    }

    // 2. Keyword-Analyse f√ºr PRIORIT√ÑT
    // Standard: Nimm das, was der User sagt
    let priority = ticketData.urgency; 
    
    // Override: Wenn extreme Signalw√∂rter fallen, setze auf HIGH
    if (text.match(/ausfall|stillstand|critical|notfall|dringend|sofort|produktion|server down/)) {
      priority = 'HIGH';
    }

    console.log("ü§ñ Lokale Simulation ausgef√ºhrt:", { category, priority });
    return { categoryRaw: category, priorityRaw: priority };
  };

  // --- LOGIK: KI KLASSIFIZIERUNG ---
  const classifyTicket = async (ticketData) => {
    const prompt = `
      Du bist ein IT-Support-KI-Assistent.
      Analysiere das folgende Ticket und gib NUR ein JSON-Objekt zur√ºck.
      
      Eingangsdaten:
      - Betreff: "${ticketData.subject}"
      - Beschreibung: "${ticketData.description}"
      - Vom User gemeldete Dringlichkeit: "${ticketData.urgency}"

      Aufgaben:
      1. KATEGORIE bestimmen: W√§hle exakt eine aus ["PASSWORD_RESET", "HARDWARE", "SOFTWARE", "OTHER"].
      2. PRIORIT√ÑT bestimmen: ["LOW", "MEDIUM", "HIGH"].
         - √úbernimm User-Dringlichkeit, au√üer bei Produktionsausfall (dann HIGH).

      Ausgabeformat (JSON):
      { "category": "KATEGORIE", "priority": "PRIORIT√ÑT" }
    `;

    try {
      // Wenn kein Key da ist, direkt Simulation werfen
      if (!apiKey) throw new Error("Kein API Key konfiguriert (Simulations-Modus).");

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      });

      if (!response.ok) throw new Error(`API Fehler: ${response.status}`);

      const data = await response.json();
      if (!data.candidates || !data.candidates[0]) throw new Error("Leere Antwort der KI");

      const text = data.candidates[0].content.parts[0].text;
      const jsonString = text.replace(/```json/g, '').replace(/```/g, '').trim();
      const result = JSON.parse(jsonString);

      setIsOfflineMode(false); // Echte KI hat geklappt
      return {
        categoryRaw: result.category ? result.category.toUpperCase() : 'OTHER', 
        priorityRaw: result.priority ? result.priority.toUpperCase() : 'MEDIUM'
      };

    } catch (error) {
      console.warn("‚ö†Ô∏è API fehlgeschlagen, starte Fallback:", error);
      setIsOfflineMode(true); // UI Hinweis aktivieren
      
      // FALLBACK AUFRUF
      return simulateLocalAI(ticketData);
    }
  };

  // --- EVENT HANDLER ---
  const handleTicketSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);

    const formData = new FormData(e.target);
    const newTicketData = {
      employee: formData.get('employee'),
      dept: formData.get('dept'),
      subject: formData.get('subject'),
      description: formData.get('description'),
      urgency: formData.get('urgency'),
      timestamp: new Date().toISOString()
    };

    // KI (oder Simulation) Aufruf
    const aiResult = await classifyTicket(newTicketData);

    // BPMN Logik
    const category = aiResult.categoryRaw;
    const priority = aiResult.priorityRaw;

    const isPasswordReset = category.replace('_', '').includes('PASSWORD'); 
    const isHighPriority = priority === 'HIGH';

    let status = 'OPEN';
    let autoSolved = false;

    if (isPasswordReset && !isHighPriority) {
      status = 'CLOSED';
      autoSolved = true;
    }

    const newTicket = {
      id: Date.now(),
      ...newTicketData,
      aiCategory: category,
      aiPriority: priority,
      status,
      autoSolved
    };

    setTickets([newTicket, ...tickets]);
    setLoading(false);
    
    if (autoSolved) setDashboardTab('archive');
    else setDashboardTab('inbox');
    
    setView('dashboard');
  };

  const handleAction = (id, action) => {
    setTickets(tickets.map(t => {
      if (t.id !== id) return t;
      return { ...t, status: action === 'solve' ? 'CLOSED' : 'ESCALATED' };
    }));
  };

  // --- UI KOMPONENTEN ---

  // 1. Setup Screen
  if (view === 'setup') {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
        <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center">
          <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
            <Key className="text-blue-600 w-8 h-8" />
          </div>
          <h2 className="text-2xl font-bold text-slate-800 mb-2">App Setup</h2>
          <p className="text-slate-500 mb-4">Gib deinen Google Gemini API Key ein.</p>
          <p className="text-slate-400 text-sm mb-6 bg-slate-100 p-2 rounded">
             üí° Tipp: Wenn du keinen Key hast, lass das Feld leer und klicke "√úberspringen". 
             Die App nutzt dann eine lokale Simulation.
          </p>
          <input 
            type="password" 
            placeholder="AIzaSy..." 
            className="w-full border border-slate-300 rounded-lg p-3 mb-4 focus:ring-2 focus:ring-blue-500 outline-none"
            onChange={(e) => setApiKey(e.target.value)}
          />
          <div className="flex gap-2">
            <button 
                onClick={() => {
                    localStorage.setItem('gemini_api_key', apiKey); // Auch leeren Key speichern ist ok
                    setView('form');
                }}
                className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition"
            >
                {apiKey ? 'Starten' : '√úberspringen (Simulation)'}
            </button>
          </div>
        </div>
      </div>
    );
  }

  // 2. Loading Screen
  if (loading) {
    return (
      <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center">
        <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600 mb-6"></div>
        <h2 className="text-2xl font-bold text-slate-700">Analysiere Ticket...</h2>
        <div className="mt-4 text-slate-500 text-sm">
            Entscheide zwischen Auto-Close und Support-Queue...
        </div>
      </div>
    );
  }

  // Filterung f√ºr Dashboard
  const openTickets = tickets.filter(t => t.status === 'OPEN');
  const closedTickets = tickets.filter(t => t.status !== 'OPEN');
  const displayedTickets = dashboardTab === 'inbox' ? openTickets : closedTickets;

  // Haupt-Layout
  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800">
      <nav className="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-10">
        <div className="max-w-5xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-2 font-bold text-xl">
            <Server className="text-blue-400" />
            IT Support <span className="text-blue-400">AI</span>
          </div>
          <div className="flex gap-2 items-center">
            {isOfflineMode && (
                <div className="flex items-center gap-1 text-yellow-400 text-xs font-bold mr-2 bg-yellow-400/10 px-2 py-1 rounded">
                    <WifiOff className="w-3 h-3" /> Simulation
                </div>
            )}
            <button onClick={() => setView('form')} className={`px-4 py-2 rounded-lg text-sm font-medium transition ${view === 'form' ? 'bg-blue-600' : 'hover:bg-slate-800'}`}>Neues Ticket</button>
            <button onClick={() => setView('dashboard')} className={`px-4 py-2 rounded-lg text-sm font-medium transition ${view === 'dashboard' ? 'bg-blue-600' : 'hover:bg-slate-800'}`}>Dashboard</button>
            <button onClick={() => { localStorage.removeItem('gemini_api_key'); setApiKey(''); setView('setup'); }} className="text-slate-400 hover:text-white px-2"><Key className="w-4 h-4"/></button>
          </div>
        </div>
      </nav>

      <main className="max-w-3xl mx-auto p-4 mt-6">
        
        {/* Offline Simulation Hinweis im Dashboard */}
        {isOfflineMode && view === 'dashboard' && (
            <div className="mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 text-sm text-yellow-800 flex items-start gap-2">
                <WifiOff className="w-5 h-5 flex-shrink-0" />
                <div>
                    <strong>Simulations-Modus aktiv:</strong> Die KI-API war nicht erreichbar. 
                    Ein lokaler Algorithmus hat die Tickets basierend auf Keywords klassifiziert.
                </div>
            </div>
        )}

        {/* FORMULAR */}
        {view === 'form' && (
          <div className="bg-white rounded-xl shadow-lg p-6 border border-slate-200">
            <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
              <MousePointerClick className="text-blue-600" />
              Ticket einreichen
            </h2>
            <form onSubmit={handleTicketSubmit} className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1">Dein Name</label>
                  <input required name="employee" className="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Max Mustermann" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-600 mb-1">Abteilung</label>
                  <select name="dept" className="w-full border rounded-lg p-2 bg-white">
                    <option>HR</option>
                    <option>Sales</option>
                    <option>IT</option>
                    <option>Andere</option>
                  </select>
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-600 mb-1">Betreff</label>
                <input required name="subject" className="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="z.B. Login fehlgeschlagen" />
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-600 mb-1">Problembeschreibung</label>
                <textarea required name="description" rows="4" className="w-full border rounded-lg p-2 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Beschreibe das Problem genau..."></textarea>
              </div>
              <div>
                <label className="block text-sm font-medium text-slate-600 mb-1">Gef√ºhlte Dringlichkeit</label>
                <select name="urgency" className="w-full border rounded-lg p-2 bg-white">
                  <option value="LOW">Niedrig</option>
                  <option value="MEDIUM">Mittel</option>
                  <option value="HIGH">Hoch (Blockierend)</option>
                </select>
              </div>
              <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-md transition flex items-center justify-center gap-2">
                <Send className="w-4 h-4" />
                Ticket absenden & analysieren
              </button>
            </form>
          </div>
        )}

        {/* DASHBOARD */}
        {view === 'dashboard' && (
          <div className="space-y-6">
            <div className="flex justify-between items-center">
              <h2 className="text-2xl font-bold flex items-center gap-2">
                <LayoutDashboard className="text-blue-600" />
                Support Dashboard
              </h2>
            </div>

            <div className="flex space-x-1 bg-slate-200 p-1 rounded-lg mb-4">
                <button 
                    onClick={() => setDashboardTab('inbox')}
                    className={`flex-1 flex items-center justify-center gap-2 py-2 text-sm font-bold rounded-md transition ${dashboardTab === 'inbox' ? 'bg-white text-blue-600 shadow' : 'text-slate-500 hover:text-slate-700'}`}
                >
                    <Inbox className="w-4 h-4" />
                    Offene Aufgaben ({openTickets.length})
                </button>
                <button 
                    onClick={() => setDashboardTab('archive')}
                    className={`flex-1 flex items-center justify-center gap-2 py-2 text-sm font-bold rounded-md transition ${dashboardTab === 'archive' ? 'bg-white text-blue-600 shadow' : 'text-slate-500 hover:text-slate-700'}`}
                >
                    <Archive className="w-4 h-4" />
                    Archiv / Gel√∂st ({closedTickets.length})
                </button>
            </div>

            {displayedTickets.length === 0 && (
              <div className="text-center py-12 bg-white rounded-xl border border-dashed border-slate-300">
                <p className="text-slate-400">
                    {dashboardTab === 'inbox' 
                        ? 'Keine offenen Tickets. "Handle Ticket" Queue ist leer.' 
                        : 'Keine gel√∂sten Tickets im Archiv.'}
                </p>
              </div>
            )}

            {displayedTickets.map((ticket) => (
              <TicketCard 
                key={ticket.id} 
                ticket={ticket} 
                onSolve={() => handleAction(ticket.id, 'solve')}
                onEscalate={() => handleAction(ticket.id, 'escalate')}
              />
            ))}
          </div>
        )}
      </main>
    </div>
  );
}

// Hilfskomponente
function TicketCard({ ticket, onSolve, onEscalate }) {
  const isOpen = ticket.status === 'OPEN';
  
  const priorityColors = {
    LOW: 'bg-green-100 text-green-700 border-green-200',
    MEDIUM: 'bg-yellow-100 text-yellow-700 border-yellow-200',
    HIGH: 'bg-red-100 text-red-700 border-red-200'
  };

  const categoryIcons = {
    PASSWORD_RESET: <Key className="w-4 h-4" />,
    HARDWARE: <HardDrive className="w-4 h-4" />,
    SOFTWARE: <Monitor className="w-4 h-4" />,
    OTHER: <AlertTriangle className="w-4 h-4" />
  };

  return (
    <div className={`bg-white rounded-xl shadow-sm border p-5 transition-all hover:shadow-md ${isOpen ? 'border-l-4 border-l-blue-500' : 'opacity-75'}`}>
      <div className="flex justify-between items-start mb-3">
        <div className="flex gap-2">
          <span className={`px-2 py-1 rounded text-xs font-bold border flex items-center gap-1 ${priorityColors[ticket.aiPriority] || 'bg-gray-100'}`}>
            {ticket.aiPriority} PRIO
          </span>
          <span className="px-2 py-1 rounded text-xs font-bold bg-slate-100 text-slate-600 border border-slate-200 flex items-center gap-1">
            {categoryIcons[ticket.aiCategory] || <AlertTriangle className="w-4 h-4" />}
            {ticket.aiCategory}
          </span>
        </div>
        <div className="text-xs text-slate-400">
          {new Date(ticket.timestamp).toLocaleTimeString()}
        </div>
      </div>

      <h3 className="text-lg font-bold text-slate-800 mb-1">{ticket.subject}</h3>
      <p className="text-slate-600 text-sm mb-4 bg-slate-50 p-3 rounded border border-slate-100">
        {ticket.description}
      </p>

      <div className="flex items-center justify-between pt-3 border-t border-slate-100">
        <div className="text-xs text-slate-500">
          Von: <span className="font-semibold">{ticket.employee}</span> ({ticket.dept})
        </div>

        {ticket.autoSolved && (
          <div className="flex items-center gap-1 text-green-600 text-sm font-bold bg-green-50 px-3 py-1 rounded-full">
            <CheckCircle className="w-4 h-4" />
            Automatisch gel√∂st ({ticket.aiCategory === 'PASSWORD_RESET' ? 'Simulation' : 'KI'})
          </div>
        )}

        {ticket.status === 'CLOSED' && !ticket.autoSolved && (
          <div className="flex items-center gap-1 text-blue-600 text-sm font-bold">
            <CheckCircle className="w-4 h-4" />
            Manuell gel√∂st
          </div>
        )}
         {ticket.status === 'ESCALATED' && (
          <div className="flex items-center gap-1 text-purple-600 text-sm font-bold">
            <ShieldAlert className="w-4 h-4" />
            Eskaliert
          </div>
        )}

        {isOpen && (
          <div className="flex gap-2">
            <button onClick={onSolve} className="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1.5 rounded font-bold transition">
              L√∂sen
            </button>
            <button onClick={onEscalate} className="bg-slate-200 hover:bg-slate-300 text-slate-700 text-xs px-3 py-1.5 rounded font-bold transition">
              Eskalieren
            </button>
          </div>
        )}
      </div>
    </div>
  );
}
